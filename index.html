<!DOCTYPE html>
<html>
    <head>
        <h1>Arrow keys to move</h1>
        <canvas id="canvas" ></canvas>
        <style>
            canvas {
                border: 1px solid black;
            }
        </style>
    </head>
    <body>
        <script>
            // frame setup
            (function() {
                var requestAnimationFrame = window.requestAnimationFrame;
                window.requestAnimationFrame = requestAnimationFrame;
            })();

            // canvas setup
            var canvas = document.getElementById("canvas"),
            context = canvas.getContext("2d"),
            width="800",
            height="800";

            //Drawing the road that enemies will follow
            function drawRoad() {
                context.beginPath();
                context.rect(canvas.width/2 - 40, 0, 80, canvas.height);
                context.fillStyle = "#000";
                context.fill();
                context.closePath();
            }

            var score = 0;

            //Function to display Player Score UI
            function drawScore() {
                context.font = "20px Arial";
                context.fillStyle = "#00F";
                context.fillText("Score: " + score, 8, 25);
            }

            var enemyXPos = 400-20;
            var enemyYPos = 0;

            var enemyCounter = 0;

            var interval = setInterval(increaseEnemy, 5000);
            function increaseEnemy() {
                enemyCounter++;
            }
            console.log(enemyCounter);

            function enemyInstance()
            {
                for (i = 0; i < enemyCounter; i++)
                {
                    enemyYPos++;

                    if (enemyYPos == canvas.height)
                    {
                        alert("You Lose!");
                        document.location.reload();
                    }

                    context.beginPath();
                    context.rect(enemyXPos, enemyYPos, 40, 40);
                    context.fillStyle = "#00F";
                    context.fill();
                    context.closePath();
                }
            }


            // bounding box
            var groundObjects = []

            groundObjects.push({ // ground
                x: 0,
                y: height - 5,
                width: width,
                height: 10,
                slope: false
            });
            groundObjects.push({ // left wall
                x: -5,
                y: 0,
                width: 10,
                height: height,
                slope: false
            });
            groundObjects.push({ // right wall
                x: width - 5,
                y: 0,
                width: 10,
                height: height,
                slope: false
            });
            groundObjects.push({ // ceiling
                x: 0,
                y: -5,
                width: width,
                height: 10,
                slope: false
            });

            // player class
            GameObject = {
                x: 375,
                y: 375,
                width: 50,
                height: 50,
                speed: 5,
                Xvelocity: 0,
                Yvelocity: 0,
            };

            // towers
            var towers = [];

            // controls
            keys = [];

            document.body.addEventListener("keydown", function(e) {
                keys[e.keyCode] = true;
            });
        
            document.body.addEventListener("keyup", function(e) {
                keys[e.keyCode] = false;
                GameObject.Xvelocity = 0;
                GameObject.Yvelocity = 0;
            });

            canvas.width = width;
            canvas.height = height;

            // physics class
            function physics(Player, Array) {
                // movement
                if (keys[39]) { // left
                    if (Player.Xvelocity < Player.speed) {
                        Player.Xvelocity++;
                    }
                }
                if (keys[37]) { // right
                    if (Player.Xvelocity > -Player.speed) {
                        Player.Xvelocity--;
                    }
                }
                if (keys[38]) { // down
                    if (Player.Yvelocity < Player.speed) {
                        Player.Yvelocity -= 0.5;
                    }
                }
                if (keys[40]) { // up
                    if (Player.Yvelocity > -Player.speed) {
                        Player.Yvelocity += 0.5;
                    }
                }
                if (keys[32]) { // space
                    maketower(Player);
                }

                // collision checks
                for (var i = 0; i < groundObjects.length; i++) {
                    context.rect(groundObjects[i].x, groundObjects[i].y, groundObjects[i].width, groundObjects[i].height);

                    var side = collides(Player, groundObjects[i]);

                    if (side === "left" || side === "right") {
                        Player.Xvelocity = 0;
                    }
                    else if (side === "top" || side == "bottom") {
                        Player.Yvelocity = 0;
                    }
                }
 
                Player.x += Player.Xvelocity;
                Player.y += Player.Yvelocity; 
            }

            // tower dropping
            function maketower(Player){
                var tx = Player.x;
                var ty = Player.y;

                towers.push({
                    x: tx,
                    y: ty,
                    width: 40,
                    height: 40
                });
            }

            // collision
            function collides(obj1, obj2) {
                // get variables from both objects
                var vectorX = (obj1.x + (obj1.width / 2)) - (obj2.x + (obj2.width / 2));
                var vectorY = (obj1.y + (obj1.height / 2)) - (obj2.y + (obj2.height / 2));
                var widthsum = (obj1.width / 2) + (obj2.width / 2);
                var heightsum = (obj1.height / 2) + (obj2.height / 2);
                var side = null;

                // check for overlaps
                if (Math.abs(vectorX) < widthsum && Math.abs(vectorY) < heightsum) {
                    var overlapX = widthsum - Math.abs(vectorX);
                    var overlapY = heightsum - Math.abs(vectorY);

                    if (overlapX >= overlapY) {
                        if (vectorY > 0) {
                            side = "top";
                            obj1.y += overlapY;
                        } 
                        else {
                            side = "bottom";
                            obj1.y -= overlapY;
                        }
                    }
                    else {
                        if (vectorX > 0) {
                            side = "left";
                            obj1.x += overlapX;
                        }
                        else {
                            side = "right";
                            obj1.x -= overlapX;
                        }
                    }
                }

                return side;
            }

            // draw function
            function update() {
                context.clearRect(0,0,width,height);
                drawRoad();
                drawScore();
                enemyInstance();

                context.fillStyle = "black";
                context.beginPath();

                physics(GameObject, groundObjects);

                context.fill();

                context.fillStyle = "red";
                context.fillRect(GameObject.x, GameObject.y, GameObject.width, GameObject.height);

                for (var i = 0; i < towers.length; i++) {
                    context.fillStyle = "green";
                    context.fillRect(towers[i].x + 5, towers[i].y + 5, towers[i].width, towers[i].height);
                }

                requestAnimationFrame(update);
            }

            // run game
            window.addEventListener("load", function(){
                update();
            });

        </script>
    </body>
</html>