<!DOCTYPE html>
<html>
    <head>
        <h1>Arrow keys to move, Number keys 1, 2, 3 for different walls</h1>
        <canvas id="canvas" ></canvas>
        <style>
            canvas {
                border: 1px solid black;
            }
        </style>
    </head>
    <body>
        <script>
            // frame setup
            (function() {
                var requestAnimationFrame = window.requestAnimationFrame;
                window.requestAnimationFrame = requestAnimationFrame;
            })();

            // canvas setup
            var canvas = document.getElementById("canvas"),
            context = canvas.getContext("2d"),
            width="800",
            height="800";

            var score = 0;

            // enemies
            var enemyCounter = 0;
            var enemies = [];

            function spawnenemy()
            {
                enemies.push({
                    x: 375,
                    y: 20,
                    width: 40,
                    height: 40,
                    color: 'blue'
                });
            }

            // bounding box
            var groundObjects = []

            groundObjects.push({ // ground
                x: 0,
                y: height - 5,
                width: width,
                height: 10,
                color: 'black'
            });
            groundObjects.push({ // left wall
                x: -5,
                y: 0,
                width: 10,
                height: height,
                color: 'black'
            });
            groundObjects.push({ // right wall
                x: width - 5,
                y: 0,
                width: 10,
                height: height,
                color: 'black'
            });
            groundObjects.push({ // ceiling
                x: 0,
                y: -5,
                width: width,
                height: 10,
                color: 'black'
            });

            // safe zone
            safezone = {
                x: width / 2 - 100,
                y: height / 2 - 50,
                width: 200,
                height: 100,
                color: 'cyan'
            };

            // player class
            GameObject = {
                x: 387.5,
                y: 387.5,
                width: 25,
                height: 25,
                speed: 5,
                Xvelocity: 0,
                Yvelocity: 0,
                color: 'deeppink'
            };

            // towers
            var towers = [];
            var towercd = 0;

            // controls
            keys = [];

            document.body.addEventListener("keydown", function(e) {
                keys[e.keyCode] = true;
            });
        
            document.body.addEventListener("keyup", function(e) {
                keys[e.keyCode] = false;
                GameObject.Xvelocity = 0;
                GameObject.Yvelocity = 0;
            });

            canvas.width = width;
            canvas.height = height;

            // physics class
            function physics(Player, Array, EnemyArray) {
                // movement
                if (keys[39]) { // left
                    if (Player.Xvelocity < Player.speed) {
                        Player.Xvelocity++;
                    }
                }
                if (keys[37]) { // right
                    if (Player.Xvelocity > -Player.speed) {
                        Player.Xvelocity--;
                    }
                }
                if (keys[38]) { // down
                    if (Player.Yvelocity < Player.speed) {
                        Player.Yvelocity -= 0.5;
                    }
                }
                if (keys[40]) { // up
                    if (Player.Yvelocity > -Player.speed) {
                        Player.Yvelocity += 0.5;
                    }
                }
                if (keys[49]) { // 1
                    if (towercd == 0) {
                        maketower(Player, 1);
                        towercd = 10;
                    }
                }
                if (keys[50]) { // 2
                    if (towercd == 0) {
                        maketower(Player, 2);
                        towercd = 50;
                    }
                }
                if (keys[51]) { // 3
                    if (towercd == 0) {
                        maketower(Player, 3);
                        towercd = 100;
                    }
                }

                // collision checks
                for (var i = 0; i < groundObjects.length; i++) {
                    context.rect(groundObjects[i].x, groundObjects[i].y, groundObjects[i].width, groundObjects[i].height);

                    var side = collides(Player, groundObjects[i]);

                    if (side === "left" || side === "right") {
                        Player.Xvelocity = 0;
                    }
                    else if (side === "top" || side == "bottom") {
                        Player.Yvelocity = 0;
                    }

                    for (var j = 0; j < enemies.length; j++){
                        //var side2 = collides(groundObjects[i], enemies[j]);
                        var side3 = collides(enemies[j], safezone);

                        if (side3) {
                            alert("You Lose!");
                            document.location.reload();
                        }
                    }
                }

                for (var i = 0; i < enemies.length; i++) {
                    for (var j = 0; j < towers.length; j++) {
                        context.rect(towers[j].x, towers[j].y, towers[j].width, towers[j].height);

                        var touch = collides(towers[j], enemies[i]);

                        if (touch && towers[j].hits == 1) {
                            enemies[i].color = 'white';
                            towers[j].color = 'white';

                            enemies[i].x = 30;
                            enemies[i].y = 30;
                            towers[j].x = 30;
                            towers[j].y = 70;

                            score += 10;
                        } else if (touch && towers[j].hits > 1) {
                            enemies[i].color = 'white';
                            towers[j].hits--;

                            enemies[i].x = 30;
                            enemies[i].y = 30;

                            score += 10;
                        }
                    }
                }
 
                Player.x += Player.Xvelocity;
                Player.y += Player.Yvelocity; 
            }

            // tower dropping
            function maketower(Player, Type){
                var tx = Player.x - 12.5;
                var ty = Player.y - 12.5;

                if (Type == 1) {
                    towers.push({
                        x: tx,
                        y: ty,
                        width: 40,
                        height: 40,
                        color: 'green',
                        hits: 1
                    });
                } else if (Type == 2) {
                    towers.push({
                        x: tx,
                        y: ty,
                        width: 40,
                        height: 40,
                        color: 'yellow',
                        hits: 3
                    });
                } else if (Type == 3) {
                    towers.push({
                        x: tx,
                        y: ty,
                        width: 40,
                        height: 40,
                        color: 'purple',
                        hits: 5
                    });
                }
            }

            // collision
            function collides(obj1, obj2) {
                // get variables from both objects
                var vectorX = (obj1.x + (obj1.width / 2)) - (obj2.x + (obj2.width / 2));
                var vectorY = (obj1.y + (obj1.height / 2)) - (obj2.y + (obj2.height / 2));
                var widthsum = (obj1.width / 2) + (obj2.width / 2);
                var heightsum = (obj1.height / 2) + (obj2.height / 2);
                var side = null;

                // check for overlaps
                if (Math.abs(vectorX) < widthsum && Math.abs(vectorY) < heightsum) {
                    var overlapX = widthsum - Math.abs(vectorX);
                    var overlapY = heightsum - Math.abs(vectorY);

                    if (overlapX >= overlapY) {
                        if (vectorY > 0) {
                            side = "top";
                            obj1.y += overlapY;
                        } 
                        else {
                            side = "bottom";
                            obj1.y -= overlapY;
                        }
                    }
                    else {
                        if (vectorX > 0) {
                            side = "left";
                            obj1.x += overlapX;
                        }
                        else {
                            side = "right";
                            obj1.x -= overlapX;
                        }
                    }
                }

                return side;
            }
            
            // enemy paths
            function drawRoad() {
                context.beginPath();
                context.rect(canvas.width/2 - 40, 0, 80, canvas.height);
                context.fillStyle = "#000";
                context.fill();
                context.closePath();
            }

            // function to display Player Score UI
            function drawScore() {
                context.font = "20px Arial";
                context.fillStyle = "#00F";
                context.fillText("Score: " + score, 8, 25);
            }

            // draw function
            function update() {
                context.clearRect(0,0,width,height);

                // draw features
                drawRoad();
                drawScore();

                for (var i = 0; i < groundObjects.length; i++) {
                    context.fillStyle = groundObjects[0].color;
                    context.fillRect(groundObjects[i].x, groundObjects[i].y, groundObjects[i].width, groundObjects[i].height);
                }

                // draw safe zone
                context.fillStyle = safezone.color;
                context.fillRect(safezone.x, safezone.y, safezone.width, safezone.height);

                context.font = "40px Arial";
                context.fillStyle = "#FFF";
                context.fillText("SAFE", width/2 - 55, height/2 + 15);

                // spawn enemies at intervals
                enemyCounter++;
                var interval = enemyCounter % 200;

                if (interval == 0){
                    spawnenemy();
                }
                
                // draw enemies
                for (var i = 0; i < enemies.length; i++) {
                    enemies[i].y++;
                    context.fillStyle = enemies[i].color;

                    if (enemies[i].color != 'white') {
                        context.fillRect(enemies[i].x + 5, enemies[i].y + 5, enemies[i].width, enemies[i].height);
                    }
                }

                // game physics
                physics(GameObject, groundObjects, enemies);

                // draw towers
                for (var i = 0; i < towers.length; i++) {
                    context.fillStyle = towers[i].color;
                    context.fillRect(towers[i].x + 5, towers[i].y + 5, towers[i].width, towers[i].height);
                }

                if (towercd > 0) {
                    towercd--;
                }

                // draw player
                context.fillStyle = GameObject.color;
                context.fillRect(GameObject.x, GameObject.y, GameObject.width, GameObject.height);

                requestAnimationFrame(update);
            }

            // run game
            window.addEventListener("load", function(){
                update();
            });

        </script>
    </body>
</html>